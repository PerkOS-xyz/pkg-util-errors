{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * @perkos/error-handling\n * Error handling utilities and classes for vendor services\n */\n\nimport { ZodError } from \"zod\";\n\n/**\n * Base application error class\n * Extends Error with HTTP status code and context\n */\nexport class AppError extends Error {\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n  public readonly context?: Record<string, any>;\n\n  constructor(\n    message: string,\n    statusCode: number = 500,\n    isOperational: boolean = true,\n    context?: Record<string, any>\n  ) {\n    super(message);\n    Object.setPrototypeOf(this, new.target.prototype);\n\n    this.name = this.constructor.name;\n    this.statusCode = statusCode;\n    this.isOperational = isOperational;\n    this.context = context;\n\n    Error.captureStackTrace(this);\n  }\n\n  toJSON() {\n    return {\n      error: this.message,\n      statusCode: this.statusCode,\n      context: this.context,\n    };\n  }\n}\n\n/**\n * Validation error class\n * For request validation failures with Zod integration\n */\nexport class ValidationError extends AppError {\n  public readonly details?: any;\n\n  constructor(message: string = \"Validation failed\", details?: any) {\n    super(message, 400, true, { details });\n    this.details = details;\n  }\n\n  /**\n   * Create ValidationError from ZodError\n   */\n  static fromZodError(error: ZodError): ValidationError {\n    const details = error.errors.map((e) => ({\n      path: e.path.join(\".\"),\n      message: e.message,\n      code: e.code,\n    }));\n    return new ValidationError(\"Validation error\", details);\n  }\n\n  toJSON() {\n    return {\n      error: this.message,\n      details: this.details,\n      statusCode: this.statusCode,\n      context: this.context,\n    };\n  }\n}\n\n/**\n * Payment error class\n * For x402 payment-related failures\n */\nexport class PaymentError extends AppError {\n  public readonly reason?: string;\n  public readonly transactionHash?: string;\n\n  constructor(\n    message: string,\n    reason?: string,\n    transactionHash?: string,\n    context?: Record<string, any>\n  ) {\n    super(message, 402, true, context);\n    this.reason = reason;\n    this.transactionHash = transactionHash;\n  }\n\n  toJSON() {\n    return {\n      error: this.message,\n      reason: this.reason,\n      transactionHash: this.transactionHash,\n      statusCode: this.statusCode,\n      context: this.context,\n    };\n  }\n}\n\n/**\n * Not found error class\n */\nexport class NotFoundError extends AppError {\n  constructor(message: string = \"Resource not found\", context?: Record<string, any>) {\n    super(message, 404, true, context);\n  }\n}\n\n/**\n * Unauthorized error class\n */\nexport class UnauthorizedError extends AppError {\n  constructor(message: string = \"Unauthorized\", context?: Record<string, any>) {\n    super(message, 401, true, context);\n  }\n}\n\n/**\n * Forbidden error class\n */\nexport class ForbiddenError extends AppError {\n  constructor(message: string = \"Forbidden\", context?: Record<string, any>) {\n    super(message, 403, true, context);\n  }\n}\n\n/**\n * Rate limit error class\n */\nexport class RateLimitError extends AppError {\n  public readonly retryAfter?: number;\n\n  constructor(\n    message: string = \"Rate limit exceeded\",\n    retryAfter?: number,\n    context?: Record<string, any>\n  ) {\n    super(message, 429, true, context);\n    this.retryAfter = retryAfter;\n  }\n\n  toJSON() {\n    return {\n      error: this.message,\n      retryAfter: this.retryAfter,\n      statusCode: this.statusCode,\n      context: this.context,\n    };\n  }\n}\n\n/**\n * Service unavailable error class\n */\nexport class ServiceUnavailableError extends AppError {\n  constructor(message: string = \"Service unavailable\", context?: Record<string, any>) {\n    super(message, 503, true, context);\n  }\n}\n\n/**\n * Check if error is operational (expected) or programming error\n */\nexport function isOperationalError(error: Error): boolean {\n  if (error instanceof AppError) {\n    return error.isOperational;\n  }\n  return false;\n}\n\n/**\n * Error response formatter for API responses\n */\nexport interface ErrorResponse {\n  error: string;\n  message?: string;\n  details?: any;\n  statusCode: number;\n}\n\n/**\n * Format error for API response\n */\nexport function formatErrorResponse(error: unknown): ErrorResponse {\n  if (error instanceof ZodError) {\n    const validationError = ValidationError.fromZodError(error);\n    return validationError.toJSON() as ErrorResponse;\n  }\n\n  if (error instanceof AppError) {\n    return error.toJSON() as ErrorResponse;\n  }\n\n  if (error instanceof Error) {\n    return {\n      error: error.message,\n      statusCode: 500,\n    };\n  }\n\n  return {\n    error: \"Unknown error\",\n    statusCode: 500,\n  };\n}\n\n/**\n * Get HTTP status code from error\n */\nexport function getErrorStatusCode(error: unknown): number {\n  if (error instanceof AppError) {\n    return error.statusCode;\n  }\n  if (error instanceof ZodError) {\n    return 400;\n  }\n  return 500;\n}\n\n/**\n * Create error handler middleware (framework-agnostic)\n */\nexport function createErrorHandler(options?: {\n  logger?: (error: Error, context?: Record<string, any>) => void;\n  includeStack?: boolean;\n}) {\n  return (error: unknown) => {\n    const response = formatErrorResponse(error);\n    const statusCode = getErrorStatusCode(error);\n\n    if (options?.logger && error instanceof Error) {\n      options.logger(error, { statusCode });\n    }\n\n    if (options?.includeStack && error instanceof Error) {\n      (response as any).stack = error.stack;\n    }\n\n    return { response, statusCode };\n  };\n}\n"],"mappings":"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","names":[]}